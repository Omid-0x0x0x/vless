
name: Auto Update VPN Configs

# ุงู workflow ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉุงููฺฏโูุง VPN ุฑุง ุฏุงูููุฏุ ูพุฑุฏุงุฒุด ู ุจูโุฑูุฒุฑุณุงู ูโฺฉูุฏ

on:
  # ุงุฌุฑุง ุฎูุฏฺฉุงุฑ ูุฑ 6 ุณุงุนุช ฺฉุจุงุฑ
  schedule:
    - cron: '0 */6 * * *'
  
  # ุงูฺฉุงู ุงุฌุฑุง ุฏุณุช ุงุฒ ุทุฑู GitHub UI
  workflow_dispatch:

jobs:
  update-configs:
    runs-on: ubuntu-latest
    
    steps:
      # ูุฑุญูู 1: ุฏุงูููุฏ ฺฉุฏ ุงุฒ repository
      - name: ๐ฅ Checkout repository
        uses: actions/checkout@v3
        with:
          # ุฏุงูููุฏ ุชูุงู history ุจุฑุง git operations
          fetch-depth: 0
      
      # ูุฑุญูู 2: ูุตุจ Python
      - name: ๐ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          # ุงุณุชูุงุฏู ุงุฒ cache ุจุฑุง ุณุฑุนุช ุจุดุชุฑ
          cache: 'pip'
      
      # ูุฑุญูู 3: ูุตุจ dependencies ููุฑุฏ ูุงุฒ
      - name: ๐ฆ Install dependencies
        run: |
          echo "Installing PySocks for proxy support..."
          pip install PySocks --break-system-packages
          
          echo "โ Dependencies installed successfully"
      
      # ูุฑุญูู 4: ูพุงฺฉ ฺฉุฑุฏู ูุงูโูุง ูุฏู
      - name: ๐งน Clean old configs
        run: |
          echo "Cleaning old config files..."
          rm -rf configs/
          mkdir -p configs/
          
          echo "โ Old configs cleaned"
      
      # ูุฑุญูู 5: ุฏุงูููุฏ ู ูพุฑุฏุงุฒุด ฺฉุงููฺฏโูุง
      - name: ๐ Fetch and process configs
        run: |
          echo "================================================"
          echo "Starting config fetch and processing..."
          echo "================================================"
          
          # ุจุฑุฑุณ ูุฌูุฏ ูุงู subscriptions
          if [ ! -f subscriptions.txt ]; then
            echo "โ Error: subscriptions.txt not found!"
            echo "Please create this file with your subscription URLs"
            exit 1
          fi
          
          # ููุงุด ุชุนุฏุงุฏ subscription ูุง
          SUBS_COUNT=$(grep -v '^#' subscriptions.txt | grep -v '^$' | wc -l)
          echo "๐ Found $SUBS_COUNT subscription URLs"
          
          # ุงุฌุฑุง pingco
          echo ""
          echo "Starting pingco.py..."
          echo ""
          
          python3 pingco.py \
            -sub subscriptions.txt \
            -name configs/base \
            -icmp \
            -split 300
          
          # ุจุฑุฑุณ ููููุช
          if [ $? -eq 0 ]; then
            echo ""
            echo "โ Config processing completed successfully!"
            
            # ููุงุด ุขูุงุฑ
            if [ -d configs ]; then
              FILE_COUNT=$(ls -1 configs/*.txt 2>/dev/null | wc -l)
              echo "๐ Created $FILE_COUNT config files"
            fi
          else
            echo "โ Error in config processing!"
            exit 1
          fi
        continue-on-error: false
      
      # ูุฑุญูู 6: ุจุฑุฑุณ ุชุบุฑุงุช
      - name: ๐ Check for changes
        id: check_changes
        run: |
          if [ -d configs ] && [ "$(ls -A configs)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "โ New configs are ready to commit"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "โ๏ธ No new configs generated"
          fi
      
      # ูุฑุญูู 7: Commit ู Push (ููุท ุงฺฏุฑ ุชุบุฑ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ)
      - name: ๐พ Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # ุชูุธู git config
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ุงุถุงูู ฺฉุฑุฏู ูุงูโูุง
          git add configs/
          
          # ุจุฑุฑุณ ุงูฺฉู ูุงูุนุงู ุชุบุฑ ูุฌูุฏ ุฏุงุฑุฏ
          if git diff --staged --quiet; then
            echo "โน๏ธ No changes to commit"
          else
            # ุณุงุฎุช commit message ุจุง ุชุงุฑุฎ ู ุฒูุงู
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
            FILE_COUNT=$(ls -1 configs/*.txt | wc -l)
            
            git commit -m "๐ Auto-update configs - $TIMESTAMP" \
                       -m "๐ Generated $FILE_COUNT config files"
            
            # Push ุจู GitHub
            git push
            
            echo "โ Changes pushed to GitHub successfully!"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ูุฑุญูู 8: ููุงุด ุฎูุงุตู
      - name: ๐ Summary
        if: always()
        run: |
          echo ""
          echo "================================================"
          echo "๐ Workflow Summary"
          echo "================================================"
          echo "Execution time: $(date '+%Y-%m-%d %H:%M:%S')"
          
          if [ -d configs ]; then
            FILE_COUNT=$(ls -1 configs/*.txt 2>/dev/null | wc -l)
            echo "Files generated: $FILE_COUNT"
            
            # ููุงุด ุญุฌู ูุงูโูุง
            TOTAL_SIZE=$(du -sh configs | cut -f1)
            echo "Total size: $TOTAL_SIZE"
            
            # ููุงุด ุชุนุฏุงุฏ ฺฉุงููฺฏโูุง ุฏุฑ ุงููู ูุงู
            if [ -f configs/base1_icmp.txt ]; then
              CONFIG_COUNT=$(wc -l < configs/base1_icmp.txt)
              echo "Configs in first file: $CONFIG_COUNT"
            fi
          else
            echo "โ๏ธ No configs directory found"
          fi
          
          echo "================================================"
          echo "โ Workflow completed!"
          echo "================================================"
